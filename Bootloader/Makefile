# Makefile para Bootloader COS773
# IMPORTANTE: Linhas de comando devem come√ßar com TAB!

# Vari√°veis
AS = as
LD = ld
QEMU = qemu-system-i386
TARGET = bootloader.img
SOURCE = bootloader.s
OBJECT = bootloader.o

# Regra principal
all: $(TARGET)

# Compila assembly para objeto
$(OBJECT): $(SOURCE)
	$(AS) --32 $(SOURCE) -o $(OBJECT)

# Liga objeto para imagem bin√°ria
$(TARGET): $(OBJECT)
	$(LD) -m elf_i386 -Ttext 0x7c00 --oformat binary -o $(TARGET) $(OBJECT)
	@echo "‚úÖ Bootloader compilado com sucesso!"
	@echo "üìÅ Tamanho: $$(stat -c%s $(TARGET)) bytes"

# Testa no QEMU
test: $(TARGET)
	@echo "üöÄ Iniciando QEMU..."
	$(QEMU) -fda $(TARGET)

# Debug com QEMU
debug: $(TARGET)
	@echo "üêõ Iniciando QEMU em modo debug..."
	@echo "Em outro terminal: gdb -> target remote :1234"
	$(QEMU) -fda $(TARGET) -s -S

# Informa√ß√µes do arquivo
info: $(TARGET)
	@echo "=== INFORMA√á√ïES DO BOOTLOADER ==="
	@echo "Arquivo: $(TARGET)"
	@echo "Tamanho: $$(stat -c%s $(TARGET)) bytes"
	@echo "Assinatura de boot (√∫ltimos 2 bytes):"
	@xxd -l 2 -s +510 $(TARGET)

# Limpa arquivos gerados
clean:
	@echo "üßπ Limpando arquivos..."
	rm -f $(OBJECT) $(TARGET)

# Reinstala depend√™ncias
deps:
	@echo "üì¶ Instalando depend√™ncias..."
	sudo apt update
	sudo apt install -y build-essential qemu-system-x86 xxd

# Verifica ferramentas
check:
	@echo "üîç Verificando ferramentas..."
	@which $(AS) || echo "‚ùå 'as' n√£o encontrado"
	@which $(LD) || echo "‚ùå 'ld' n√£o encontrado" 
	@which $(QEMU) || echo "‚ùå 'qemu-system-i386' n√£o encontrado"
	@which xxd || echo "‚ö†Ô∏è  'xxd' n√£o encontrado (opcional)"

# Ajuda
help:
	@echo "=== MAKEFILE BOOTLOADER COS773 ==="
	@echo "Comandos dispon√≠veis:"
	@echo "  make all    - Compila o bootloader"
	@echo "  make test   - Testa no QEMU"
	@echo "  make debug  - Debug com GDB"
	@echo "  make info   - Mostra informa√ß√µes"
	@echo "  make clean  - Limpa arquivos"
	@echo "  make deps   - Instala depend√™ncias"
	@echo "  make check  - Verifica ferramentas"
	@echo "  make help   - Mostra esta ajuda"

# Declara alvos que n√£o s√£o arquivos
.PHONY: all test debug info clean deps check help
